{% extends 'base.html' %}

{% load static %}

{% block content %}
{% include 'navbar.html' %}

    <div class = "m-8">
        <div class = "flex font-bold mb-8 text-center text-9xl justify-center items-center gap-x-3">
            <img src="{% static 'image/makanre.png' %}">
            <h1 class = "text-9xl text-center text-[#292929]">Nyari apa lee</h1>
            <h1 class = "text-9xl text-center text-[#eec201]">..</h1>
        </div>
        <div class = "">
            <form method="GET" action="{% url 'main:search_on_full' %}">
                <div class = "flex justify-between items-center gap-x-4 text-[#292929]">
                    {% csrf_token %}
                    <div class = "flex relative w-[80%]">
                        <input required name="query" class="shadow-lg py-2 focus:ring-0 border-none rounded-full px-4 w-full block" type="text" placeholder="Search" value="{{ query|default:'' }}">
                        <button type="submit" class="absolute rounded-full top-1 sm:top-1 md:top-1 xl:top-1 right-2">
                        <img src="{% static 'image/search.png' %}" class="w-5 h-5 md:w-6 md:h-6 lg:w-8 lg:h-8 transition-transform duration-200 ease-in-out transform hover:scale-110" alt="Search">
                    </div>
                    </button>
                    <div class = "flex gap-x-8">
                            <div class = "flex items-center gap-1">
                                <img class = "w-5 h-5" src = "{% static 'image/filter.png' %}">
                                <select name="filter" id="filterSelect" class="appearance-none focus:ring-0 px-2 rounded-full py-2 font-[Poppins] bg-white border-none shadow-lg pr-8" onchange="updateResults()">
                                    <option value="all" {% if filtered == 'all' %}selected{% endif %}>Search All</option>
                                    <option value="restaurant" {% if filtered == 'restaurant' %}selected{% endif %}>Restaurant Only</option>
                                    <option value="food" {% if filtered == 'food' %}selected{% endif %}>Food Only</option>
                                </select>
                            </div>
                                
                            <div class ="flex items-center gap-1">
                                <svg class = "w-7 h-7" fill="#000000" width="800px" height="800px" viewBox="0 0 36 36" version="1.1"  preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                    <title>sort-by-line</title>
                                    <path d="M28.54,13H7.46a1,1,0,0,1,0-2H28.54a1,1,0,0,1,0,2Z" class="clr-i-outline clr-i-outline-path-1"></path><path d="M21.17,19H7.46a1,1,0,0,1,0-2H21.17a1,1,0,0,1,0,2Z" class="clr-i-outline clr-i-outline-path-2"></path><path d="M13.74,25H7.46a1,1,0,0,1,0-2h6.28a1,1,0,0,1,0,2Z" class="clr-i-outline clr-i-outline-path-3"></path>
                                    <rect x="0" y="0" width="36" height="36" fill-opacity="0"/>
                                </svg>
                                <select name="sort" class="appearance-none focus:ring-0 px-2 rounded-full py-2 font-[Poppins] bg-white border-none shadow-lg pr-8" onchange="updateResults()">
                                    <option value="none" {% if sort == 'none' %}selected{% endif %}>Not Sorted</option>
                                    <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                                    <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                                    <option value="alpha_asc" {% if sort == 'alpha_asc' %}selected{% endif %}>Alphabet A-Z</option>
                                    <option value="alpha_desc" {% if sort == 'alpha_desc' %}selected{% endif %}>Alphabet Z-A</option>
                                </select>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div id = "hasildata" class="mt-6 mx-8 mb-40">
            {% if results %}
            <div class="grid grid-cols-4 gap-x-8 gap-y-8">
                {% for result in results %}
                    <div class="bg-opacity-50 p-4 rounded-xl bg-white w-auto h-auto hover:scale-105 duration-300 flex flex-col justify-between">
                        <div>
                            <img class="rounded-xl w-full h-full" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS61ao6YP55xtV77AZl_cci0EKcDiquIfzuTw&s">
                        </div>
                        <div class="mt-4">
                            <div class="font-bold font-[Poppins] text-2xl mb-2 line-clamp-2">
                                {{ result.name }}
                            </div>
                            <div class="font-[lora] text-sm">
                                {{ result.restaurant.name }}
                            </div>
                        </div>
                        <div class="px-2 py-1 mt-2 bg-[#eec201] rounded-xl font-[Poppins] font-bold text-[#292929] text-lg text-right">
                            Rp.{{ result.price }}
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% else %}
                <p>No results found.</p>
            {% endif %}
        </div>        
    </div>


    <script>
        function updateResults() {
            //tambahin csrf ulang
            const csrfToken = '{{ csrf_token }}';
            const sortValue = document.querySelector('select[name="sort"]').value;
            const query = document.querySelector('input[name="query"]').value;
            const filterValue = document.querySelector('select[name="filter"]').value;
        
            const url = `/search_page/?query=${encodeURIComponent(query)}&filter=${encodeURIComponent(filterValue)}&sort=${encodeURIComponent(sortValue)}&csrfmiddlewaretoken=${encodeURIComponent(csrfToken)}`;

            fetch(url, {
                //pake get lebi gmpg dan data ga sensitif
                method: 'GET', 
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',  
                    'Content-Type': 'application/json',  
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); 
            })
            .then(data => {
                document.getElementById('hasildata').innerHTML = data.html; // Update results
            })
            .catch(error => {
                console.error('Error updating results:', error);
            });
        }
    </script>
    
{% endblock %}
