{% extends 'base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto my-10 p-6 bg-white rounded shadow-lg">
    <!-- Informasi Produk -->
    <h1 class="text-3xl font-bold mb-4">{{ product.name }}</h1>
    <p class="text-gray-800"><strong>Description:</strong> {{ product.description|default:"-" }}</p>
    <p class="text-gray-800"><strong>Category:</strong> {{ product.category }}</p>
    <p class="text-gray-800"><strong>Price:</strong> {{ product.price }}</p>

    <hr class="my-6">

    <!-- Tampilkan Rata-rata Rating -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-2">Rating</h2>
        <p id="avg-rating" class="text-yellow-500 font-bold text-lg">{{ avg_rating|floatformat:1 }}/5</p>
    </div>

    <!-- Bagian Review -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4">Reviews</h2>
        <div id="review-list-container" class="space-y-4">
            {% if reviews %}
                <ul id="review-list" class="space-y-4">
                    {% for review in reviews %}
                    <li class="p-4 bg-gray-100 rounded">
                        <p><strong>{{ review.user.username }}</strong> rated: {{ review.rating }}/5</p>
                        <p>{{ review.review }}</p>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p id="no-reviews-message">No reviews yet.</p>
            {% endif %}
        </div>
    </div>

    <hr class="my-6">

    <!-- Bagian Tambah Review -->
    <div class="bg-gray-50 p-4 rounded shadow-md">
        <h2 class="text-2xl font-semibold mb-4">Add Your Rating & Review</h2>
        <form id="review-form" method="POST" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block font-semibold mb-1" for="rating">Add Your Rating:</label>
                {{ review_form.rating }}
            </div>
            <div>
                <label class="block font-semibold mb-1" for="review">Add Your Review:</label>
                {{ review_form.review }}
            </div>

            <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">
                Submit Rating & Review
            </button>
        </form>
    </div>
</div>

<!-- Tambahkan kode JavaScript di sini -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        headers: { 'X-CSRFToken': csrftoken }
    });

    $('#review-form').on('submit', function(e) {
    e.preventDefault();

    $.ajax({
        type: 'POST',
        url: "/product/{{ product.id }}/",
        data: $(this).serialize(),
        success: function(response) {
            // Log data respons untuk debugging
            console.log("Response Data:", response);

            // Perbarui rata-rata rating
            $('#avg-rating').text(response.avg_rating.toFixed(1) + "/5");

            // Hilangkan pesan "No reviews yet." jika ada
            if ($('#no-reviews-message').length) {
                $('#no-reviews-message').remove();
            }

            // Cek apakah ul#review-list sudah ada, jika belum buat baru
            if ($('#review-list').length === 0) {
                $('#review-list-container').append('<ul id="review-list" class="space-y-4"></ul>');
            }

            // Tambahkan review baru ke daftar review
            $('#review-list').append(`
                <li class="p-4 bg-gray-100 rounded">
                    <p><strong>${response.username}</strong> rated: ${response.rating}/5</p>
                    <p>${response.review}</p>
                </li>
            `);

            // Reset form setelah submit
            $('#review-form')[0].reset();
        },
        error: function(xhr, status, error) {
            console.error("Error Details:", xhr.responseText);
            alert('An error occurred: ' + xhr.responseText);
        }
    });
});
</script>
{% endblock %}