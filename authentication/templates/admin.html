{% extends 'base.html' %}

{% block content %}
<style>
    .modal {
        display: none;
        align-items: center;
        justify-content: center;
    }
    body {
        font-family: 'Lora', serif;
    }
    h1, h2, button, li {
        font-family: 'Poppins', sans-serif;
    }
    input, select, textarea {
        border: 1px solid black;
        padding: 0.5rem;
        width: 100%;
    }
    label {
        text-align: left;
        display: block;
        margin-bottom: 0.5rem;
    }
    .full-screen-center {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
    }
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .search-bar {
        display: flex;
        align-items: center;
        flex-grow: 1;
        border: 1px solid black;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-right: 1rem;
    }
    .search-bar input {
        border: none;
        padding: 0.5rem;
        flex-grow: 1;
    }
    .search-bar select {
        border: none;
        padding: 0.5rem;
        width: auto;
    }
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
    }
    .action-buttons button {
        background-color: white;
        border: 1px solid black;
        color: black;
        font-family: 'Poppins', sans-serif;
        font-weight: bold;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: transform 0.3s ease-in-out;
    }
    .action-buttons button:hover {
        transform: scale(1.05);
    }
</style>

<div class="container mx-auto p-6 bg-white text-black font-lora leading-normal text-base tracking-normal">
    <div class="top-bar">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search...">
            <select id="search-type">
                <option value="restaurant">Restaurant</option>
                <option value="food">Food</option>
            </select>
        </div>
        <div>
            <button type="button" id="open-restaurant-modal-btn" class="bg-white border border-black text-black font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 font-poppins">Add Restaurant</button>
            <button type="button" id="open-food-modal-btn" class="bg-white border border-black text-black font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 font-poppins">Add Food</button>
        </div>
    </div>

    <div id="list-container">
        <h2 class="text-3xl font-bold mb-6 text-black font-poppins">Restaurants</h2>
        <ul id="restaurant-list" class="list-disc pl-5 space-y-2">
            {% for restaurant in restaurants %}
            <li class="bg-white p-4 rounded-lg shadow-md border border-black font-poppins relative" data-id="{{ restaurant.id }}">
                {{ restaurant.name }} - {{ restaurant.location }}
                <div class="action-buttons">
                    <button type="button" class="edit-restaurant-btn">Edit</button>
                    <button type="button" class="delete-restaurant-btn">Delete</button>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Modal for adding/editing restaurant -->
    <div id="restaurant-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex">
        <div class="modal-content bg-white rounded-lg shadow-lg p-8 w-11/12 md:w-1/2 flex flex-col relative border border-black">
            <span class="close text-gray-500 hover:text-gray-700 cursor-pointer text-2xl font-bold absolute top-4 right-4" id="close-restaurant-modal">&times;</span>
            <h2 class="text-3xl font-bold mb-6 text-center text-black font-poppins">Add/Edit Restaurant</h2>
            <form id="restaurant-form" method="post" class="space-y-4 flex-grow flex flex-col">
                {% csrf_token %}
                <table class="w-full">
                    {{ restaurant_form.as_table }}
                </table>
                <button type="submit" id="add-restaurant-btn" class="bg-white border border-black text-black font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 w-full mt-auto font-poppins">Add/Edit Restaurant</button>
            </form>
        </div>
    </div>

    <!-- Modal for adding/editing food -->
    <div id="food-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex">
        <div class="modal-content bg-white rounded-lg shadow-lg p-8 w-11/12 md:w-1/2 flex flex-col relative border border-black">
            <span class="close text-gray-500 hover:text-gray-700 cursor-pointer text-2xl font-bold absolute top-4 right-4" id="close-food-modal">&times;</span>
            <h2 class="text-3xl font-bold mb-6 text-center text-black font-poppins">Add/Edit Food</h2>
            <form id="food-form" method="post" class="space-y-4 flex-grow flex flex-col">
                {% csrf_token %}
                <table class="w-full">
                    {{ food_form.as_table }}
                </table>
                <button type="submit" id="add-food-btn" class="bg-white border border-black text-black font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 w-full mt-auto font-poppins">Add/Edit Food</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('open-restaurant-modal-btn').addEventListener('click', function() {
        document.getElementById('restaurant-modal').style.display = 'flex';
    });

    document.getElementById('close-restaurant-modal').addEventListener('click', function() {
        document.getElementById('restaurant-modal').style.display = 'none';
    });

    document.getElementById('open-food-modal-btn').addEventListener('click', function() {
        document.getElementById('food-modal').style.display = 'flex';
    });

    document.getElementById('close-food-modal').addEventListener('click', function() {
        document.getElementById('food-modal').style.display = 'none';
    });

    document.getElementById('add-restaurant-btn').addEventListener('click', function(event) {
        event.preventDefault();
        var form = document.getElementById('restaurant-form');
        var formData = new FormData(form);
        fetch("{% url 'authentication:add_restaurant' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var restaurantList = document.getElementById('restaurant-list');
                var newRestaurant = document.createElement('li');
                newRestaurant.className = 'bg-white p-4 rounded-lg shadow-md border border-black font-poppins relative';
                newRestaurant.textContent = data.restaurant.name + ' - ' + data.restaurant.location;
                newRestaurant.dataset.id = data.restaurant.id;
                var actionButtons = document.createElement('div');
                actionButtons.className = 'action-buttons';
                actionButtons.innerHTML = '<button type="button" class="edit-restaurant-btn">Edit</button><button type="button" class="delete-restaurant-btn">Delete</button>';
                newRestaurant.appendChild(actionButtons);
                restaurantList.appendChild(newRestaurant);
                form.reset();
                document.getElementById('restaurant-modal').style.display = 'none';
                attachEventListeners();
            } else {
                alert('Failed to add restaurant');
            }
        });
    });

    document.getElementById('add-food-btn').addEventListener('click', function(event) {
        event.preventDefault();
        var form = document.getElementById('food-form');
        var formData = new FormData(form);
        fetch("{% url 'authentication:add_food' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var foodList = document.getElementById('food-list');
                var newFood = document.createElement('li');
                newFood.className = 'bg-white p-4 rounded-lg shadow-md border border-black font-poppins relative';
                newFood.textContent = data.food.name + ' - ' + data.food.description + ' - ' + data.food.category + ' - ' + data.food.restaurant.name + ' - ' + data.food.price;
                newFood.dataset.id = data.food.id;
                var actionButtons = document.createElement('div');
                actionButtons.className = 'action-buttons';
                actionButtons.innerHTML = '<button type="button" class="edit-food-btn">Edit</button><button type="button" class="delete-food-btn">Delete</button>';
                newFood.appendChild(actionButtons);
                foodList.appendChild(newFood);
                form.reset();
                document.getElementById('food-modal').style.display = 'none';
                attachEventListeners();
            } else {
                alert('Failed to add food: ' + JSON.stringify(data.errors));
            }
        });
    });

    document.getElementById('search-input').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            var searchInput = document.getElementById('search-input').value;
            var searchType = document.getElementById('search-type').value;
            var listContainer = document.getElementById('list-container');
            
            fetch("{% url 'authentication:search' %}?type=" + encodeURIComponent(searchType) + "&query=" + encodeURIComponent(searchInput))
            .then(response => response.json())
            .then(data => {
                if (searchType === 'restaurant') {
                    listContainer.innerHTML = '<h2 class="text-3xl font-bold mb-6 text-black font-poppins">Restaurants</h2><ul id="restaurant-list" class="list-disc pl-5 space-y-2"></ul>';
                    var restaurantList = document.getElementById('restaurant-list');
                    data.results.forEach(function(restaurant) {
                        var newRestaurant = document.createElement('li');
                        newRestaurant.className = 'bg-white p-4 rounded-lg shadow-md border border-black font-poppins relative';
                        newRestaurant.textContent = restaurant.name + ' - ' + restaurant.location;
                        newRestaurant.dataset.id = restaurant.id;
                        var actionButtons = document.createElement('div');
                        actionButtons.className = 'action-buttons';
                        actionButtons.innerHTML = '<button type="button" class="edit-restaurant-btn">Edit</button><button type="button" class="delete-restaurant-btn">Delete</button>';
                        newRestaurant.appendChild(actionButtons);
                        restaurantList.appendChild(newRestaurant);
                    });
                } else {
                    listContainer.innerHTML = '<h2 class="text-3xl font-bold mb-6 text-black font-poppins">Foods</h2><ul id="food-list" class="list-disc pl-5 space-y-2"></ul>';
                    var foodList = document.getElementById('food-list');
                    data.results.forEach(function(food) {
                        var newFood = document.createElement('li');
                        newFood.className = 'bg-white p-4 rounded-lg shadow-md border border-black font-poppins relative';
                        newFood.textContent = food.name + ' - ' + food.description + ' - ' + food.category + ' - ' + food.restaurant.name + ' - ' + food.price;
                        newFood.dataset.id = food.id;
                        var actionButtons = document.createElement('div');
                        actionButtons.className = 'action-buttons';
                        actionButtons.innerHTML = '<button type="button" class="edit-food-btn">Edit</button><button type="button" class="delete-food-btn">Delete</button>';
                        newFood.appendChild(actionButtons);
                        foodList.appendChild(newFood);
                    });
                }
                attachEventListeners();
            });
        }
    });

    function attachEventListeners() {
        document.querySelectorAll('.edit-restaurant-btn').forEach(button => {
            button.addEventListener('click', function() {
                var li = this.parentElement.parentElement;
                var restaurantId = li.dataset.id;
                fetch("{% url 'authentication:get_restaurant' %}?id=" + restaurantId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        var form = document.getElementById('restaurant-form');
                        form.querySelector('[name="name"]').value = data.restaurant.name;
                        form.querySelector('[name="location"]').value = data.restaurant.location;
                        form.action = "{% url 'authentication:edit_restaurant' %}?id=" + restaurantId;
                        document.getElementById('restaurant-modal').style.display = 'flex';
                    } else {
                        alert('Failed to fetch restaurant data');
                    }
                });
            });
        });

        document.querySelectorAll('.delete-restaurant-btn').forEach(button => {
            button.addEventListener('click', function() {
                var li = this.parentElement.parentElement;
                fetch("{% url 'authentication:delete_restaurant' %}", {
                    method: 'POST',
                    body: JSON.stringify({ id: li.dataset.id }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        li.remove();
                    } else {
                        alert('Failed to delete restaurant');
                    }
                });
            });
        });

        document.querySelectorAll('.edit-food-btn').forEach(button => {
            button.addEventListener('click', function() {
                var li = this.parentElement.parentElement;
                var foodId = li.dataset.id;
                fetch("{% url 'authentication:get_food' %}?id=" + foodId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        var form = document.getElementById('food-form');
                        form.querySelector('[name="name"]').value = data.food.name;
                        form.querySelector('[name="description"]').value = data.food.description;
                        form.querySelector('[name="category"]').value = data.food.category;
                        form.querySelector('[name="restaurant"]').value = data.food.restaurant.id;
                        form.querySelector('[name="price"]').value = data.food.price;
                        form.action = "{% url 'authentication:edit_food' %}?id=" + foodId;
                        document.getElementById('food-modal').style.display = 'flex';
                    } else {
                        alert('Failed to fetch food data');
                    }
                });
            });
        });

        document.querySelectorAll('.delete-food-btn').forEach(button => {
            button.addEventListener('click', function() {
                var li = this.parentElement.parentElement;
                fetch("{% url 'authentication:delete_food' %}", {
                    method: 'POST',
                    body: JSON.stringify({ id: li.dataset.id }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        li.remove();
                    } else {
                        alert('Failed to delete food');
                    }
                });
            });
        });
    }

    attachEventListeners();
</script>

{% endblock content %}